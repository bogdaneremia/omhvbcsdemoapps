# Steps for configuring a JET mobile app with OMH Client to support Push Notifications (Android)
This tutorial shows you how to create an Oracle JET Mobile application and configure it with Oracle Mobile Hub Client to support Push Notifications (Android build).

## Introduction

Scope:
-	Use default autogenerated JET app (template _navdrawer_)
-	Configure with OMH Client SDK and create Login / Logout Page
-	Configure with OMH Cordova Push Notification Plugin
-	Send push notifications via Google Firebase
-	Handle push notification and navigate to a custom page

Overall Cloud environment prerequisites:
-	Google and Firebase account
-	OMH Instance + IDCS access for managing users

Overall local environment prerequisites:
-	Oracle JET environment: Git, npm, JET CLI
-	Cordova
-	OMH Client SDK for Cordova Applications
-	OMH Push Notifications Cordova Plugin
-	Cordova Device Plugin (cordova-plugin-device)
-	Postman (for sending Push notifications)

Disclaimer:
-	Because of new versions constantly being released, this tutorial might not work in the future; other workarounds might be needed or, things might work easily
-	Versions used in this case:
    *	Windows 10, Windows Power Shell
    *	OMH Push Notifications Cordova: amce-cordova-sdk-v18.3.3.0
    *	OMH Instance: 19.1.3 
    *	Oracle JET CLI: 7.0.0
    *	npm: 6.4.1
    *	Cordova: 9.0.0
    *	Android: 8.0.0
    *	Gradle: 5.4.1
    *	Java JDK: jdk1.8.0_201

## Cloud Environment Prerequisites

-	Create Google (email) account:
    *	https://mail.google.com
    *	(mobile phone number, recovery email not mandatory)
-	Activate / Access Google Firebase
    *	https://console.firebase.google.com/

-	Get access to/Create OMH Instance in a tenancy
-	Create a Mobile Backend

## Local Environment Prerequisites

Reference links: [Oracle JET Get Started](https://docs.oracle.com/en/middleware/developer-tools/jet/7/develop/getting-started-oracle-javascript-extension-toolkit-jet.html), [Oracle JET – Hybrid Apps](https://docs.oracle.com/en/middleware/developer-tools/jet/7/develop/understanding-hybrid-mobile-application-development-workflow.html)

-	Install Node.js, npm: https://nodejs.org/en/download/
-	Install Gradle: https://gradle.org/install/
-	Install Oracle JET CLI
    ```sh
	$ npm install -g @oracle/ojet-cli
    ```
    *	Verify Installation:
    ```sh
	$ ojet –version
    ```
-	Install cordova
    ```sh
	$ npm install -g cordova
    ```
-	Install Android Studio
    *	https://developer.android.com/studio/index.html
    *	Choose to install an Emulator Accelerator
    *	Choose for AVD Manager
    *	Install an Android Virtual Device (AVD) using AVD Manager if it doesn’t ship a default one
    *	Keep a note with the AVD name or change the default AVD name to eliminate white spaces
-	Depending on the Android device brand:
    *	Enable Developer Options on the device
    *	Install USB drivers if using a Windows Machine: https://developer.android.com/studio/run/oem-usb.html
-	Configure required environment variables:
    *	JAVA_HOME (Java JDK install, ex. value: C:\Programs\Oracle\Java\jdk1.8.0_201\)
    *	ANDROID_HOME (Android SDK install, ex. value: C:\Programs\Google\Android\SDK)
    *	ANDROID_SDK_ROOT (same value as ANDROID_HOME)
    *	Path
        +	add/check following entries added to the end (example for Windows):
        	```sh
			C:\Programs\Gradle\gradle-5.4.1\bin
			C:\Programs\Google\Android\SDK\emulator
			C:\Programs\Google\Android\SDK\tools
			C:\Programs\Google\Android\SDK\tools\bin
			C:\Programs\Google\Android\SDK\platform-tools
        	```
        +	The order is important, Android\SDK\emulator must be loaded first, otherwise problems might occur when launching the Android emulator

-	Download OMH Cordova Client SDK
    *	Safest way: go to OMH Instance Console > Development Menu > Downloads
    *	Accept License Agreement
    *	Download latest __Cordova SDK__ from OMC / AMCE SDKS section (for example amce-cordova-sdk-v18.3.3.0.zip)
    *	Unpack the .zip in a working root folder, under a folder with the name as the .zip file
    *	Folder structure should be:
        ```sh
		amce-cordova-sdk-v18.3.3.0\oracle-mcs-notifications-cordova-plugin
		amce-cordova-sdk-v18.3.3.0\types
		amce-cordova-sdk-v18.3.3.0\package.json
		…
        ```
    *	To fix some future build errors, change the following line in the amce-cordova-sdk-v18.3.3.0\oracle-mcs-notifications-cordova-plugin\scripts\android-before-build.js file:
        ```sh        
		const ANDROID_PLATFORM_SRC_PATH = 'platforms/android/src';
        ```
		with
        ```sh
        const ANDROID_PLATFORM_SRC_PATH = 'platforms/android/app/src/main/java';
        ```
    *	To force to an old version for Firebase dependency (at the time of writing this, latest oracle-mcs-notifications-cordova-plugin wasn’t compatible with the latest __firebase-core__ and __firebase-messaging__ packages) change the following lines in the \amce-cordova-sdk-v18.3.3.0\oracle-mcs-notifications-cordova-plugin\plugin.xml file:
        ```
		<framework src="com.google.firebase:firebase-core:+" />
		<framework src="com.google.firebase:firebase-messaging:+" />
        ```
		with
        ```
		<framework src="com.google.firebase:firebase-core:16.0.3" />
		<framework src="com.google.firebase:firebase-messaging:17.6.0" />
        ```

## App development

Reference Links: [OMH Cordova Applications](https://docs.oracle.com/en/cloud/paas/mobile-hub/develop/cordova-applications.html#GUID-31E21FD2-37BD-4B19-80E7-3B3A00A77784), [JET – Package and publish Hybrid Mobile Apps](https://docs.oracle.com/en/middleware/developer-tools/jet/7/develop/package-and-publish-hybrid-mobile-applications.html#GUID-DBA8BB97-1989-45B0-8C86-4897D5F302A9),  [JET Hybrid apps tutorial](https://www.oracle.com/webfolder/technetwork/tutorials/cloud/jet_hybrid/JET_Hybrid_Apps.html) 

### 1st step: start building the app and test.

-	In a folder where you wish to create the app folder, execute:
    ```sh 
	$ ojet create mobile-app-navdrawer-hybrid-test --hybrid --appname="Sample NavDrawer Test" --template=navdrawer --platform=android
    ```
    *	Where:
        +	_mobile-app-navdrawer-hybrid-test_ will be the Oracle JET project name and top folder name
        +	_Sample NavDrawer Test_ will be the Android mobile app name as displayed on the mobile screen
        +	_navdrawer_ – default JET template of the app (with navigation drawer)

-	Let’s first test the app in a browser (chrome as default):
    ```sh 
	$ cd mobile-app-navdrawer-hybrid-test
	$ ojet clean copy android
	$ ojet build android
	$ ojet serve android --destination=browser
    ```
	
    *	Play with the app: http://localhost:8000 (CTRL + C to shut down)

### 2nd step: Add OMH SDK client and test login/logout

-	In the tenancy of your OMH Instance, go to IDCS console and create a new user or use your username
-	In the OMH Instance Console go to Roles (Development > Roles) and create a test role, for example _omh_test_role_
-	In the OMH Instance Console go to your mobile backend: Development > Backends > \[your mobile backend\] > Security
    *	Enable Role-based Access
    *	Select the previously created role under Roles field
-	To add your user to the role, go to IDCS console:
    *	Go to Applications and find the Application corresponding to your OMH instance, usually with the name MobileStandard_\[omh instance name\]
    *	Open the Application
    *	Go to > Application roles and you’ll see a role with the name of the one created in the OMH Instance console
    *	Assign to that role your user (Role actions > Assign users)
-	Open the mobile-app-navdrawer-hybrid-test project an IDE or just use a file editor (the suggested folder/source files structure in the following steps can be change as needed)
-	Create a folder /src/js/mcs
-	Create a folder /src/js/mbe
-	Copy amce-cordova-sdk-v18.3.3.0/mcs.js from the unpacked OMH client sdk to the /src/js/mcs folder
-	Create a mbe.js javascript file in the /src/js/mbe folder with the source code of the example [mbe.js] file; edit the file and replace all placeholders for the mcs_config with the appropriate values from Mobile Backend Settings page in the OMH Instance Console; most important in this case:
    *	Backend Name
    *	Backend Id
    *	Backend Base URL
-	Edit the /src/js/main.js file and add the OMH Client SDK (mcs.js) reference at the end of path listings:
    ```
	'css': 'libs/require-css/css',
	'touchr': 'libs/touchr/touchr',
	'mcs': 'mcs/mcs'
	```
-	Change the /src/js/viewModels/dashboard.js and /src/js/views/dashboard.html source code with the example [dashboard.js] and [dashboard.html] files

-	To prevent CORS errors edit your OMH Instance Policy. Go to OMH Instance Console > Settings > Policies:
    *	Export Policy file
    *	Change the Security_AllowOrigin setting by replacing the line with:
		```
		*.*.Security_AllowOrigin=http\://localhost\:*
		```
    *	Import the Policy file

-	Let’s test the app in the emulator
    *	Make sure the Android Virtual Device (Android Studio > AVD Manager) is stopped before running the serve command
    *	Run in the project folder:
		```sh
		$ ojet clean copy android
		$ ojet build android
		$ ojet serve android --destination=emulator:Nexus
		```
        +	Replace Nexus with your AVD name
        +	Wait for the emulator to power up
    *	Test Login/Logout; Double check in OMH Instance Console > Development > Backends > \[your backend\] > Diagnostics > Requests for successful login calls

### 3rd step: add required plugins and test Push Notifications with Google Firebase

-	Create a project in Google Firebase
    *	First, get the get the generated appplicationID:
        +	Open file \[project folder\] \hybrid\platforms\android\app\src\main\AndroidManifest.xml
        +	The package attribute at top level xml manifest tag represents the applicationID
        +	In this case: org.oraclejet.mobileappnavdrawerhybridtest
    *	Go to Google Firebase and create a new project:
        +	ProjectName: any name as you wish
        +	Location: select suitable values
    *	Go to Project Settings:
        +	Select a Support email address
    *	In _Your Apps_ section add a new Android App:
        +	Android Package Name: the applicationID value that we extracted earlier
        +	Register App
        +	Download google-services.json file
        +	Save that inside the \[project folder\]\hybrid\ folder
        +	Place another copy of the filer in the \[project folder\]\hybrid\platforms\android\app folder
        +	Next (ignore gradle steps, will be handled by the OMH Push Notifications Cordova Plugin)
        +	Skip _Checking Communication with servers_ step
-	Add cordova plugins
    *	From the project folder, go to the hybrid folder and add the plugins using cordova CLI:
		```sh
		$ cd .\hybrid\
		$ pwd
		(…)\mobile-app-navdrawer-hybrid-test\hybrid 
		$ cordova plugin add ..\..\amce-cordova-sdk-v18.3.3.0\oracle-mcs-notifications-cordova-plugin
		```
    *	You may change the above path of the plugin depending the location where you unpacked the OMH Cordova SDK
    *	oracle-mcs-notifications-cordova-plugin requires cordova-plugin-device plugin:
		```sh
		$ cordova plugin add cordova-plugin-device
		```
-	Enable device registration and push notifications in the app:
    *	Edit the \[project folder\]/src/js/mbe/mbe.js file
    *	Uncomment the //handleDeviceReady() call in the self.authenticate function definition
        +	This allows to get a device token from Google Firebase and to register that to OMH Push Notification system
    *	Uncomment the handleDeviceReady, handleTokenRefresh, handleRegisterForNotifications and handleMessageReceived functions definitions
        +	The handleMessageReceived function handles a push notification; in our case, depending on the custom json payload, we navigate to another page
    *	Update the handleTokenRefresh function code, with proper values for the packageName and appVersion variables:
        +	packageName: the applicationID value that we extracted earlier
        +	appVersion: it has to be the same version specified in the AndroidManifest.xml file, attribute android:versionName (1.0.0 in our case)

-	Configure OMH for Push Notifications
    *	Go to OMH Instance Console > Development > Backends > \[your mobile backend\]
    *	Go to Clients Tab and add a new Client:
        +	Set a Client Name / Display Name
        +	Platform: Android
        +	Package name: the applicationID value that we have extracted earlier
        +	Mobile App Version: appVersion value that we have extracted earlier
        +	Create
    *	Switch to Profiles tab in the newly created Client and Create a new Profile:
        +	Set a profile Name
        +	Notification Service: Firebase Cloud Messaging (FCM)
        +	Send Method: HTTP
        +	API Key: You get this value from the Google Firebase Console > \[Your project\] > Settings > Cloud Messaging Tab > Project Credentials section > Server Key (it has to be a long string)
        +	Sender ID: You get this value from the same section as above, Sender ID field value
        +	Create
    *	Now, OMH should be able to contact Google Firebase in order to send push notifications to your app

-	Rebuild the app (execute in the project folder, not in the hybrid folder):
	```sh
	$ ojet clean copy android
	$ ojet build android
	```
-	Next, we are installing on the real device; it must be connected, USB debug enabled, Internet connection available for testing:
	```sh
	$ ojet serve android –device
	```
-	Test the App
    *	Fire Login on the Dashboard page
    *	Check Device registration in OHM Instance Console
        +	Go to Development > \[your mobile backend\] > Notifications > Manage Devices
        +	A new device should have appeared here; if not check the Request history and look for error messages
        +	Option to debug: Use Chrome to inspect JS console of the mobile app
    *	Use Postman to invoke OMH Push Notifications Service that will send a push notification to the app through Google Firebase
        +	HTTP Method: POST
        +	Endpoint: \[mobile backend base url\]/mobile/system/notifications/notifications/
        +	Authentication: Basic; use your OHM user credentials
        +	Headers:
        >		Content-Type: application/json
        >		oracle-mobile-backend-id: [your mobile backend id value]
        +	Body: Use the content of the [postman.js] example file
        +	Before invoking minimize the app
        +	Invoke; you should receive a 201 Create HTTP response code
        +	You should receive a Push Notification on the device
        +	If you open the push notification, it will open the app and navigate to the Customers page; you can customize the payload in Postman and change the page id; The redirect fully dynamic and based on the Push Notification custom json payload.

[dashboard.html]: jet_omh_push_notifications/src/dashboard.html
[dashboard.js]: jet_omh_push_notifications/src/dashboard.js
[mbe.js]: jet_omh_push_notifications/src/mbe.js
[postman.js]: jet_omh_push_notifications/src/postman.js
